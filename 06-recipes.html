<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>alvu | documentation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/alvu/styles.css" />
  </head>

  <body>
    <header class="container">
<nav>
<p><a href=/alvu/index>..</a></p>
<p><a href=/alvu/00-readme> readme</a></p>
<p><a href=/alvu/01-basics> basics</a></p>
<p><a href=/alvu/03-concepts> concepts</a></p>
<p><a href=/alvu/04-dev-server> dev server</a></p>
<p><a href=/alvu/05-CLI> cli</a></p>
<p><a href=/alvu/06-recipes> recipes</a></p>
</nav>
</header>
<main class="container">
<h1 id="recipes">Recipes</h1>
<h3 id="toc">TOC</h3>
<ul>
<li><a href="#watching-for-changes">Watching for Changes</a></li>
<li><a href="#importing-other-lua-files">Importing Other lua files</a></li>
<li><a href="#string-interpolation">String Interpolation</a></li>
<li><a href="#string-functions">String Functions</a></li>
<li><a href="#get-files-from-a-directory">Get Files from a Dir</a></li>
<li><a href="#reading--writing-files">Reading Writing Files</a></li>
<li><a href="#getting-network-data">Getting network Data</a></li>
<li><a href="#templates">Templates</a></li>
</ul>
<p>Methods and ways to be able to do basic tasks while working with alvu</p>
<h2 id="watching-for-changes">Watching for changes</h2>
<p>I use <a href="https://github.com/eradman/entr">entr</a> as a file notifier which can run
arbitrary commands on file changes, which can be done like so to have alvu
monitor for files</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>ls docs/**/* | entr -cr alvu --path=<span style="font-style:italic">&#39;./docs&#39;</span>
</span></span></code></pre><blockquote>
<p><strong>Note</strong>: since v0.2.9, alvu comes with it's own file watcher and live-reload
but is limited to the <code>public</code> and <code>pages</code> directory and it is still
recommended to use <code>entr</code> if you wish to handle watching custom paths</p>
</blockquote>
<p>This will list all files in the <code>docs</code> folder (root of an alvu project) and then
run the alvu command while specifying the base path to be <code>./docs</code></p>
<h2 id="importing-other-lua-files">Importing other lua files</h2>
<p>You'll need to work with lua files that are in a sibling directory in the
project and you can do so by adding them to the scripts <code>package.path</code> like so</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="font-style:italic">-- specify that you wish to taken in any `.lua` file in the `lib` folder</span>
</span></span><span style="display:flex;"><span>package.path = package.path .. <span style="font-style:italic">&#34;;../lib/?.lua&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">-- require lib/utils.lua to use utilities from it</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">local</span> lib = require(<span style="font-style:italic">&#34;lib.utils&#34;</span>)
</span></span></code></pre><h2 id="string-interpolation">String Interpolation</h2>
<p>There's no way to directly do string interpolation in lua but is almost always
needed so here's how you can implement a small helper for it</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="font-weight:bold">local</span> <span style="font-weight:bold">function</span> interpolate(s, tab)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">return</span> (s:gsub(<span style="font-style:italic">&#39;($%b{})&#39;</span>, <span style="font-weight:bold">function</span>(w) <span style="font-weight:bold">return</span> tab[w:sub(3, -2)] <span style="font-weight:bold">or</span> w <span style="font-weight:bold">end</span>))
</span></span><span style="display:flex;"><span><span style="font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">-- usage</span>
</span></span><span style="display:flex;"><span>interpolate(<span style="font-style:italic">&#34;this is an ${message} string&#34;</span>, { message = <span style="font-style:italic">&#34;interpolated&#34;</span> })
</span></span></code></pre><h2 id="string-functions">String Functions</h2>
<p>A helper library is injected into all alvu hook files which can be required into
the script to help with basic string manipulation and querying</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="font-weight:bold">local</span> strings = require(<span style="font-style:italic">&#34;strings&#34;</span>)
</span></span><span style="display:flex;"><span><span style="font-weight:bold">if</span> strings.contains(<span style="font-style:italic">&#34;hello world&#34;</span>, <span style="font-style:italic">&#34;hello&#34;</span>)
</span></span><span style="display:flex;"><span><span style="font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>	print(<span style="font-style:italic">&#34;found hello&#34;</span>)
</span></span><span style="display:flex;"><span><span style="font-weight:bold">end</span>
</span></span></code></pre><p>You can read more about these from the
<a href="https://github.com/vadv/gopher-lua-libs/tree/master/strings">gopher-lua-libs</a>
repo.</p>
<h2 id="get-files-from-a-directory">Get files from a directory</h2>
<p>If working with blogs and nested data you might wanna get files in a directory
and you can use the following function</p>
<p>There's 2 methods, you can either use the <code>alvu</code> helper library or you can add
the <code>scandir</code> function shown below to your <code>libs</code> folder if you wish to maintain
control over the file reading functionality</p>
<ul>
<li>Using <code>alvu</code> helpers</li>
</ul>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="font-weight:bold">local</span> alvu = require(<span style="font-style:italic">&#34;alvu&#34;</span>)
</span></span><span style="display:flex;"><span><span style="font-weight:bold">local</span> all_files = alvu.files(path)
</span></span></code></pre><ul>
<li>Custom function</li>
</ul>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="font-weight:bold">function</span> scandir(directory)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">local</span> i, t, popen = 0, {}, io.popen
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">local</span> pfile = popen(<span style="font-style:italic">&#39;ls -a &#34;&#39;</span> .. directory .. <span style="font-style:italic">&#39;&#34;&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">if</span> pfile <span style="font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">for</span> filename <span style="font-weight:bold">in</span> pfile:lines() <span style="font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>            i = i + 1
</span></span><span style="display:flex;"><span>            t[i] = filename
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>        pfile:close()
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">return</span> t
</span></span><span style="display:flex;"><span><span style="font-weight:bold">end</span>
</span></span></code></pre><h2 id="reading--writing-files">Reading / Writing files</h2>
<p>This can be done with native lua functions but here's a snippet of the
<code>onFinish</code> hook from <a href="https://github.com/barelyhuman/reaper.is">reaper.is</a>' RSS
Feed hook</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="font-weight:bold">function</span> OnFinish()
</span></span><span style="display:flex;"><span>    <span style="font-style:italic">-- attempt to open the template file in read mode</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">local</span> rss_temp_fd = io.open(<span style="font-style:italic">&#34;dist/rss_tmpl.xml&#34;</span>, <span style="font-style:italic">&#34;r&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="font-style:italic">-- attempt to open the final file in write mode</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">local</span> rss_fd = io.open(<span style="font-style:italic">&#34;dist/rss.xml&#34;</span>, <span style="font-style:italic">&#34;w&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="font-style:italic">-- check if the file descriptors are available and usable</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">if</span> rss_temp_fd <span style="font-weight:bold">and</span> rss_fd
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>		<span style="font-style:italic">-- read the entire template file&#39;s body</span>
</span></span><span style="display:flex;"><span>		<span style="font-style:italic">-- which contains the rss &lt;item&gt;&lt;/item&gt; tags</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">local</span> body = <span style="font-style:italic">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">for</span> c <span style="font-weight:bold">in</span> rss_temp_fd:lines() <span style="font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>            body = body .. <span style="font-style:italic">&#34;</span><span style="font-weight:bold;font-style:italic">\n</span><span style="font-style:italic">&#34;</span> .. c
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="font-style:italic">-- generate a rss file template for the following</span>
</span></span><span style="display:flex;"><span>		<span style="font-style:italic">-- site data</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">local</span> rss_data = rss_template({
</span></span><span style="display:flex;"><span>            site_name = <span style="font-style:italic">&#34;reaper&#34;</span>,
</span></span><span style="display:flex;"><span>            site_link = <span style="font-style:italic">&#34;https://reaper.is&#34;</span>,
</span></span><span style="display:flex;"><span>            site_description = <span style="font-style:italic">&#34;reaper&#39;s rants,notes and stuff&#34;</span>,
</span></span><span style="display:flex;"><span>            itembody = body
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="font-style:italic">-- write the whole thing to the final rss.xml file</span>
</span></span><span style="display:flex;"><span>        rss_fd:write(rss_data)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">end</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">end</span>
</span></span></code></pre><h2 id="getting-network-data">Getting Network Data</h2>
<p>Getting data at build time for dynamic data is a very common usecase and this is
something that alvu supports.</p>
<p>The network data needs to be fetched from a hook, let's take a simple example.</p>
<p>I need to get downloads for a certain set of packages that've been published to
the NPM Registry.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="font-style:italic">-- require the needed packages. </span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">-- both http and json are injected packages by alvu and </span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">-- dont need any dependencies from lua to be added</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">local</span> http = require(<span style="font-style:italic">&#34;http&#34;</span>)
</span></span><span style="display:flex;"><span><span style="font-weight:bold">local</span> json = require(<span style="font-style:italic">&#34;json&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">-- we only want this hook to run for the file </span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">-- packages.md</span>
</span></span><span style="display:flex;"><span>ForFile = <span style="font-style:italic">&#34;packages.md&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">local</span> npm_url = <span style="font-style:italic">&#34;https://api.npmjs.org/downloads/point/last-month/&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">-- tiny utility function that takes in </span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">-- a pkg_name and returns the number of downloads from </span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">-- the request. </span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">-- we use the `json` utility to parse the text response</span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">-- into a json</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">local</span> <span style="font-weight:bold">function</span> get_downloads_for_pkg(pkg_name)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">local</span> response,error_message = http.get(npm_url..pkg_name)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">local</span> body_json = json.decode(response.body)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">return</span> body_json.downloads
</span></span><span style="display:flex;"><span><span style="font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">local</span> packages = {
</span></span><span style="display:flex;"><span>    <span style="font-style:italic">&#34;@barelyhuman/tocolor&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="font-style:italic">&#34;@barelyhuman/pipe&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="font-style:italic">&#34;@barelyhuman/preact-island-plugins&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="font-style:italic">&#34;@barelyreaper/themer&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="font-style:italic">&#34;jotai-form&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">function</span> Writer(source_data)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">local</span> source = json.decode(source_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-style:italic">-- create a table with the download count for each package,</span>
</span></span><span style="display:flex;"><span>    <span style="font-style:italic">-- mentioned in the `packages` variable</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">local</span> downloads_table = {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">for</span> k,pkg_name <span style="font-weight:bold">in</span> ipairs(packages) <span style="font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">local</span> download_count = get_downloads_for_pkg(pkg_name)
</span></span><span style="display:flex;"><span>        table.insert(downloads_table,{
</span></span><span style="display:flex;"><span>            title = pkg_name,
</span></span><span style="display:flex;"><span>            downloads = download_count
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-style:italic">-- Pass down the data to file that&#39;s being rendered, in this case `packages.md` </span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">return</span> json.encode({
</span></span><span style="display:flex;"><span>		data = {
</span></span><span style="display:flex;"><span>			packages = downloads_table,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span><span style="font-weight:bold">end</span>
</span></span></code></pre><p>Once you have the hook ready, you can now add in the file this is for.
<code>pages/packages.md</code></p>
<p>Which would look, something like this.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="font-weight:bold"># Packages
</span></span></span><span style="display:flex;"><span><span style="font-weight:bold"></span>
</span></span><span style="display:flex;"><span>| name                     | downloads(last 30 days) |
</span></span><span style="display:flex;"><span>| ------------------------ | ----------------------- |
</span></span><span style="display:flex;"><span>|                   |                         |
</span></span></code></pre><p>Here the <code>range .Data.packages</code> loops through the elements that were returned
from the hook on the <code>data</code> parameter, and you can now point to the variables
you need to get the required data into the template.</p>
<h2 id="templates">Templates</h2>
<p>The most preferred way of using alvu is to avoid having to construct hooks and
use existing example repositories as the source, this gives us the advantage of
not having to spend time writing similar static site generation logic while
keeping it easy to extend.</p>
<h3 id="official-templates">Official Templates</h3>
<p><a href="https://github.com/barelyhuman/alvu-foam-template">alvu-foam-template</a> - Foam
plugin template for writing a wiki styled website</p>
<h3 id="community-templates">Community Templates</h3>
<p>Feel free to add in your templates here via PR's on the
<a href="http://github.com/barelyhuman/alvu">source repo</a> or mailing
<a href="mailto:ahoy@barelyhuman.dev">me</a></p>
</main>
    <footer class="container">
      Built with <a href="http://github.com/barelyhuman/alvu">alvu</a>
    </footer>
  </body>
</html>
